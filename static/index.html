<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Agent - Pipeline Comparison</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a; color: #e2e8f0;
        }

        /* ---- Dashboard View ---- */
        #dashboard-view { min-height: 100vh; }
        .header {
            background: #1e293b; padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #334155; text-align: center;
        }
        .header h1 { font-size: 1.4rem; color: #f1f5f9; }
        .header p { font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem; }
        .grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 1rem; padding: 1.25rem; max-width: 1000px; margin: 0 auto;
        }
        .card {
            background: #1e293b; border-radius: 12px; padding: 1.5rem;
            border: 1px solid #334155; transition: all 0.2s; cursor: default;
        }
        .card:hover { border-color: #475569; }
        .card h2 { font-size: 1.05rem; color: #f1f5f9; margin-bottom: 0.5rem; }
        .badges { display: flex; gap: 0.4rem; margin-bottom: 1rem; }
        .badge {
            font-size: 0.65rem; padding: 0.2rem 0.55rem; border-radius: 9999px;
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.02em;
        }
        .badge-stt { background: #1e3a5f; color: #93c5fd; }
        .badge-tts { background: #3b1f5e; color: #c4b5fd; }
        .card-desc {
            font-size: 0.78rem; color: #94a3b8; margin-bottom: 1rem; line-height: 1.4;
        }
        .btn {
            padding: 0.55rem 1.25rem; border-radius: 8px; border: none;
            cursor: pointer; font-size: 0.85rem; font-weight: 600;
            transition: all 0.15s; width: 100%;
        }
        .btn-connect { background: #3b82f6; color: #fff; }
        .btn-connect:hover { background: #2563eb; }

        /* ---- Client View ---- */
        #client-view {
            display: none; flex-direction: column; height: 100vh;
        }
        .client-bar {
            background: #1e293b; padding: 0.6rem 1rem;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #334155; flex-shrink: 0;
        }
        .client-bar-info {
            display: flex; align-items: center; gap: 0.75rem;
            font-size: 0.85rem;
        }
        .client-bar-info .pipeline-label { color: #f1f5f9; font-weight: 600; }
        .client-bar-info .badge { font-size: 0.6rem; }
        .btn-back {
            padding: 0.4rem 0.9rem; border-radius: 6px; border: 1px solid #475569;
            background: transparent; color: #94a3b8; cursor: pointer;
            font-size: 0.8rem; font-weight: 500; transition: all 0.15s;
        }
        .btn-back:hover { background: #334155; color: #f1f5f9; }

        /* ---- Flow Steps Bar ---- */
        .flow-bar {
            background: #1e293b; padding: 0.65rem 1rem;
            border-bottom: 1px solid #334155; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            gap: 0; overflow-x: auto;
        }
        .flow-step {
            display: flex; align-items: center; gap: 0;
            white-space: nowrap;
        }
        .flow-dot {
            width: 26px; height: 26px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.6rem; font-weight: 700;
            border: 2px solid #475569; background: transparent;
            color: #64748b; transition: all 0.3s;
            flex-shrink: 0;
        }
        .flow-dot.active {
            border-color: #3b82f6; background: #3b82f6; color: #fff;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
        }
        .flow-dot.done {
            border-color: #22c55e; background: #22c55e; color: #fff;
        }
        .flow-label {
            font-size: 0.62rem; color: #64748b; margin-left: 0.3rem;
            margin-right: 0.4rem; transition: color 0.3s;
        }
        .flow-label.active { color: #93c5fd; font-weight: 600; }
        .flow-label.done { color: #86efac; }
        .flow-connector {
            width: 20px; height: 2px; background: #334155;
            margin: 0 0.1rem; flex-shrink: 0;
            transition: background 0.3s;
        }
        .flow-connector.done { background: #22c55e; }

        /* ---- Main Content (full-width iframe) ---- */
        #client-iframe {
            flex: 1; border: none; width: 100%; background: #0f172a;
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; padding: 0.75rem; }
        }
    </style>
</head>
<body>
    <!-- Dashboard: pipeline selector grid -->
    <div id="dashboard-view">
        <div class="header">
            <h1>Loan Collection Agent &mdash; Pipeline Comparison</h1>
            <p>Select a pipeline to start a voice conversation. Flow stages are tracked in real-time.</p>
        </div>
        <div class="grid" id="grid"></div>
    </div>

    <!-- Client: full-screen prebuilt UI with flow tracking -->
    <div id="client-view">
        <div class="client-bar">
            <div class="client-bar-info">
                <span class="pipeline-label" id="active-label"></span>
                <span class="badge badge-stt" id="active-stt"></span>
                <span class="badge badge-tts" id="active-tts"></span>
            </div>
            <button class="btn-back" onclick="backToDashboard()">Back to Dashboard</button>
        </div>

        <!-- Flow Steps Visualization -->
        <div class="flow-bar" id="flow-bar"></div>

        <!-- Prebuilt client (full width, conversation + metrics tabs built in) -->
        <iframe id="client-iframe" src="about:blank" allow="microphone"></iframe>
    </div>

    <script>
    const PIPELINES = [
        {
            stt: 'deepgram', tts: 'openai',
            label: 'Deepgram + OpenAI TTS',
            desc: 'Streaming STT via Deepgram Nova-3 with OpenAI TTS voice synthesis. Best overall quality.',
        },
        {
            stt: 'deepgram', tts: 'edge',
            label: 'Deepgram + Edge TTS',
            desc: 'Streaming STT via Deepgram Nova-3 with free Microsoft Edge TTS (excellent Hindi pronunciation).',
        },
        {
            stt: 'whisper', tts: 'openai',
            label: 'Whisper + OpenAI TTS',
            desc: 'OpenAI Whisper (gpt-4o-transcribe) for STT with OpenAI TTS voice synthesis.',
        },
        {
            stt: 'whisper', tts: 'edge',
            label: 'Whisper + Edge TTS',
            desc: 'OpenAI Whisper for STT with free Microsoft Edge TTS. Fully Hindi-optimized.',
        },
    ];

    // Flow node definitions (synced with bot.py FLOW_NODES)
    const FLOW_NODES = [
        { id: 'greeting', label: 'Greeting' },
        { id: 'overdue_info', label: 'Overdue Info' },
        { id: 'understand_situation', label: 'Situation' },
        { id: 'payment_options', label: 'Options' },
        { id: 'commitment', label: 'Commitment' },
        { id: 'promise_to_pay', label: 'PTP' },
        { id: 'end', label: 'Complete' },
    ];

    let pollInterval = null;

    // ---- Build pipeline cards ----
    const grid = document.getElementById('grid');

    PIPELINES.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <h2>${p.label}</h2>
            <div class="badges">
                <span class="badge badge-stt">STT: ${p.stt}</span>
                <span class="badge badge-tts">TTS: ${p.tts}</span>
            </div>
            <div class="card-desc">${p.desc}</div>
            <button class="btn btn-connect">Connect</button>
        `;
        grid.appendChild(card);

        card.querySelector('.btn-connect').addEventListener('click', () => {
            openPipeline(p);
        });
    });

    // ---- Build flow steps bar ----
    function buildFlowBar() {
        const bar = document.getElementById('flow-bar');
        bar.innerHTML = '';
        FLOW_NODES.forEach((node, i) => {
            const step = document.createElement('div');
            step.className = 'flow-step';

            const dot = document.createElement('div');
            dot.className = 'flow-dot';
            dot.id = `flow-dot-${node.id}`;
            dot.textContent = i + 1;

            const label = document.createElement('span');
            label.className = 'flow-label';
            label.id = `flow-label-${node.id}`;
            label.textContent = node.label;

            step.appendChild(dot);
            step.appendChild(label);
            bar.appendChild(step);

            if (i < FLOW_NODES.length - 1) {
                const connector = document.createElement('div');
                connector.className = 'flow-connector';
                connector.id = `flow-conn-${i}`;
                bar.appendChild(connector);
            }
        });
    }

    function updateFlowState(currentNode) {
        if (!currentNode) return;

        const currentIdx = FLOW_NODES.findIndex(n => n.id === currentNode);
        if (currentIdx === -1) return;

        FLOW_NODES.forEach((node, i) => {
            const dot = document.getElementById(`flow-dot-${node.id}`);
            const label = document.getElementById(`flow-label-${node.id}`);
            if (!dot || !label) return;

            dot.classList.remove('active', 'done');
            label.classList.remove('active', 'done');

            if (i < currentIdx) {
                dot.classList.add('done');
                label.classList.add('done');
            } else if (i === currentIdx) {
                dot.classList.add('active');
                label.classList.add('active');
            }

            if (i < FLOW_NODES.length - 1) {
                const conn = document.getElementById(`flow-conn-${i}`);
                if (conn) {
                    conn.classList.toggle('done', i < currentIdx);
                }
            }
        });
    }

    // ---- Poll for flow state ----
    async function pollFlowState() {
        try {
            const res = await fetch('/api/active-flow');
            if (!res.ok) return;
            const data = await res.json();
            updateFlowState(data.current_node);
        } catch (e) {
            // Silently ignore polling errors
        }
    }

    // ---- Pipeline selection & client view ----
    async function openPipeline(p) {
        try {
            const res = await fetch('/set-pipeline', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stt: p.stt, tts: p.tts }),
            });
            if (!res.ok) throw new Error(`set-pipeline returned ${res.status}`);
        } catch (e) {
            alert('Failed to set pipeline: ' + e.message);
            return;
        }

        // Update the top bar
        document.getElementById('active-label').textContent = p.label;
        document.getElementById('active-stt').textContent = 'STT: ' + p.stt;
        document.getElementById('active-tts').textContent = 'TTS: ' + p.tts;

        // Build flow steps
        buildFlowBar();

        // Switch views
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('client-view').style.display = 'flex';

        // Load the prebuilt client (it calls /start which picks up our pipeline)
        document.getElementById('client-iframe').src = '/client/';

        // Start polling for flow state
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(pollFlowState, 1000);
    }

    function backToDashboard() {
        // Stop polling
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }

        // Tear down the iframe (disconnects WebRTC)
        const iframe = document.getElementById('client-iframe');
        iframe.src = 'about:blank';

        // Switch views
        document.getElementById('client-view').style.display = 'none';
        document.getElementById('dashboard-view').style.display = 'block';
    }
    </script>
</body>
</html>
